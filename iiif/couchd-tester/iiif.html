<html>
	<head>
		<title>IA scan to n-triples</title>
		<meta charset="UTF-8"/>
		<script src="jquery.js"></script>
		<script src="jsonld.js"></script>
		<script src="viz.js"></script>
		<!-- stuff below needs to go into CouchDB views -->
		<script src="shared.js"></script>
		<script src="language.js"></script>
		<script src="xml2json.js"></script>
		<style>
		td { border: 1px solid red; }
		</style>
	</head>
<body>

<h1>IA Sacn</h1>

<div>
	<div style="width:100%;height:auto;">
		<h2>XML</h2>
			<textarea id="json" style="width:100%;background-color:#224FBC;color:#FFFF66;" rows="20">
{
	"_id": "https://archive.org/details/zoologische-verhandelingen-91-001-034",
	"message": {
		"xml": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><book>  <bookData>    <dpi>600</dpi>    <bookId>zoologische-verhandelingen-91-001-034</bookId>    <leafCount>33</leafCount>  </bookData>  <pageData>    <page leafNum=\"0\">      <pageType>Title</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>      <bookStart>true</bookStart>    </page>    <page leafNum=\"1\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4498</origWidth>      <origHeight>6196</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4498</w>        <h>6196</h>      </cropBox>    </page>    <page leafNum=\"2\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"3\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"4\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4497</origWidth>      <origHeight>6196</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4497</w>        <h>6196</h>      </cropBox>    </page>    <page leafNum=\"5\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4497</origWidth>      <origHeight>6195</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4497</w>        <h>6195</h>      </cropBox>    </page>    <page leafNum=\"6\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"7\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4495</origWidth>      <origHeight>6195</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4495</w>        <h>6195</h>      </cropBox>    </page>    <page leafNum=\"8\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"9\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"10\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"11\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"12\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"13\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4495</origWidth>      <origHeight>6195</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4495</w>        <h>6195</h>      </cropBox>    </page>    <page leafNum=\"14\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"15\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4495</origWidth>      <origHeight>6195</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4495</w>        <h>6195</h>      </cropBox>    </page>    <page leafNum=\"16\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"17\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"18\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"19\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4496</origWidth>      <origHeight>6195</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4496</w>        <h>6195</h>      </cropBox>    </page>    <page leafNum=\"20\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"21\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"22\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"23\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"24\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"25\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"26\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"27\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"28\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4496</origWidth>      <origHeight>6195</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4496</w>        <h>6195</h>      </cropBox>    </page>    <page leafNum=\"29\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"30\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>    <page leafNum=\"31\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4498</origWidth>      <origHeight>6197</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4498</w>        <h>6197</h>      </cropBox>    </page>    <page leafNum=\"32\">      <pageType>Normal</pageType>      <addToAccessFormats>true</addToAccessFormats>      <origWidth>4490</origWidth>      <origHeight>6190</origHeight>      <cropBox>        <x>0</x>        <y>0</y>        <w>4490</w>        <h>6190</h>      </cropBox>    </page>  </pageData></book>"	},
	"message-format": "application/xml"
}			</textarea>
			<br />
			<button onclick="convert()">Convert JSON to RDF</button>
	</div>
	<div style="clear:both;"></div>
	
	<div style="width:100%;">
		<h2>Triples</h2>
		<div id="output" style="width:100%;background-color:#FF7;color:#222;overflow:auto;"></div>
		<h2>Graph</h2>
		<div id="graph" style="width:100%;overflow:auto;"></div>
		<h2>JSON-LD</h2>
		<div id="jsonld" style="width:100%;white-space:pre;background-color:#333;color:white;overflow:auto;"></div>

</div>			
			
		
		
		
<script>

// http://stackoverflow.com/a/17076120
function decodeHTMLEntities(text) {
   var entities = [
        ['amp', '&'],
        ['apos', '\''],
        ['#x27', '\''],
        ['#x2F', '/'],
        ['#39', '\''],
	['#039', '\''],
        ['#47', '/'],
        ['lt', '<'],
        ['gt', '>'],
        ['nbsp', ' '],
        ['quot', '"']
    ];

    text = String(text);

    for (var i = 0, max = entities.length; i < max; ++i) {
        text = text.replace(new RegExp('&'+entities[i][0]+';', 'g'), entities[i][1]);
    }

    return text;
}
	
//----------------------------------------------------------------------------------------
// START COUCHDB VIEW
function message(doc) {

  var base_id = doc._id;
  var subject_id = base_id + '/manifest.json';

  var ia_id = doc._id;
  ia_id = ia_id.replace('https://archive.org/details/', '');
  
  var triples = [];
  var type = '';

  var xml = doc.message.xml;
  //alert('hi');

  // administrivia
  xml = xml.replace(/<\?xml version="1.0" encoding="UTF-8"\?>\s*/i, '');

  //alert(xml);

  var json = xml2json.parser(xml);
  
  //alert(JSON.stringify(json));
  
  /*
{"book":{"bookdata":{"dpi":600,"bookid":"zoologische-verhandelingen-91-001-034","leafcount":33},"pagedata":{"page":[{"leafnum":0,"pagetype":"Title","addtoaccessformats":"true","origwidth":4490,"origheight":6190,"cropbox":{"x":0,"y":0,"w":4490,"h":6190},"bookstart":"true"},{"leafnum":1,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4498,"origheight":6196,"cropbox":{"x":0,"y":0,"w":4498,"h":6196}},{"leafnum":2,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4490,"origheight":6190,"cropbox":{"x":0,"y":0,"w":4490,"h":6190}},{"leafnum":3,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4490,"origheight":6190,"cropbox":{"x":0,"y":0,"w":4490,"h":6190}},{"leafnum":4,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4497,"origheight":6196,"cropbox":{"x":0,"y":0,"w":4497,"h":6196}},{"leafnum":5,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4497,"origheight":6195,"cropbox":{"x":0,"y":0,"w":4497,"h":6195}},{"leafnum":6,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4490,"origheight":6190,"cropbox":{"x":0,"y":0,"w":4490,"h":6190}},{"leafnum":7,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4495,"origheight":6195,"cropbox":{"x":0,"y":0,"w":4495,"h":6195}},{"leafnum":8,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4490,"origheight":6190,"cropbox":{"x":0,"y":0,"w":4490,"h":6190}},{"leafnum":9,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4490,"origheight":6190,"cropbox":{"x":0,"y":0,"w":4490,"h":6190}},{"leafnum":10,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4490,"origheight":6190,"cropbox":{"x":0,"y":0,"w":4490,"h":6190}},{"leafnum":11,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4490,"origheight":6190,"cropbox":{"x":0,"y":0,"w":4490,"h":6190}},{"leafnum":12,"pagetype":"Normal","addtoaccessformats":"true","origwidth":4490,"origheight":6190,"cropbox":{"x":0,"y":0,"w":4490,"h":6190}},{"leafnum":13,"pagetype":"Normal","addtoaccessformats":"*/  

/*
  <pageData>
    <page leafNum="0">
      <pageType>Title</pageType>
      <addToAccessFormats>true</addToAccessFormats>
      <origWidth>4490</origWidth>
      <origHeight>6190</origHeight>
      <cropBox>
        <x>0</x>
        <y>0</y>
        <w>4490</w>
        <h>6190</h>
      </cropBox>
      <bookStart>true</bookStart>
    </page>
*/

  if (json.book) {


    triples.push(triple(subject_id,
      'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
      'http://iiif.io/api/presentation/2#manifest'));

    triples.push(triple(subject_id,
      'http://www.w3.org/2000/01/rdf-schema#label',
      json.book.bookdata.bookid));
      
      var sequences_id = base_id + '/canvas/default';

    triples.push(triple(subject_id,
      'http://iiif.io/api/presentation/2#hasSequences',
      sequences_id));
      
     triples.push(triple(sequences_id,
      'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
      'http://iiif.io/api/presentation/2#Sequence'));
      
      
     

    for (var k in json.book.pagedata.page) {
    
        var leafnum = String(json.book.pagedata.page[k].leafnum);
        leafnum = leafnum.padStart(4, '0');
    
    	var canvas_id = base_id + '/canvas/c' + leafnum;
    	
  	
		 triples.push(triple(sequences_id,
		  'http://iiif.io/api/presentation/2#hasCanvases',
		  canvas_id));
      
      		// tyoe
		  triples.push(triple(canvas_id,
		  'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
		  'http://iiif.io/api/presentation/2#Canvas'));
 
 			// label
 		  triples.push(triple(canvas_id,
		  'http://www.w3.org/2000/01/rdf-schema#label',
		  String(json.book.pagedata.page[k].leafnum)));
 
 			// dimensions
 		  triples.push(triple(canvas_id,
		  'http://www.w3.org/2003/12/exif/ns#width',
		  String(json.book.pagedata.page[k].origwidth)));
 
 		  triples.push(triple(canvas_id,
		  'http://www.w3.org/2003/12/exif/ns#height',
		  String(json.book.pagedata.page[k].origheight)));
		  
		  
		  // annotation
		  var annotation_id = canvas_id + '/annotation';

 		  triples.push(triple(canvas_id,
		  'http://iiif.io/api/presentation/2#hasImageAnnotations',
		  annotation_id));

		  triples.push(triple(annotation_id,
		  'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
		  'http://www.w3.org/ns/oa#Annotation'));

			
		  triples.push(triple(annotation_id,
		  'http://www.w3.org/ns/oa#motivatedBy',
		  'http://iiif.io/api/presentation/2#painting'));
			
			
		  triples.push(triple(annotation_id,
		  'http://www.w3.org/ns/oa#hasTarget',
		  canvas_id));
		  
		  // resource (image URL or IIIF service)
		  
		  var resource_id = 'http://www.archive.org/download/' + ia_id + '/' + ia_id  + '/page/n' + json.book.pagedata.page[k].leafnum + '_medium.jpg';
		  
		  
 		  triples.push(triple(annotation_id,
		  'http://iiif.io/api/presentation/2#hasAnnotations',
		  resource_id));

		  triples.push(triple(resource_id,
		  'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
		  'http://purl.org/dc/dcmitype/Image'));
		  
		  triples.push(triple(resource_id,
		  'http://purl.org/dc/terms/format',
		  'image/jpeg'));

		  triples.push(triple(resource_id,
		  'http://www.w3.org/2003/12/exif/ns#width',
		  String(json.book.pagedata.page[k].origwidth)));
		  
		  triples.push(triple(resource_id,
		  'http://www.w3.org/2003/12/exif/ns#height',
		  String(json.book.pagedata.page[k].origheight)));
		  
		  
	
    
    /*
                "canvases": [
                {
                    "@id": "https://archive.org/download/zoologische-verhandelingen-91-001-034/page/n0",
                    "@type": "sc:Canvas",
                    "label": 1,
                    "width": 4490,
                    "height": 6190,*/

/*
                   "images": [
                        {
                            "@id": "https://archive.org/download/zoologische-verhandelingen-91-001-034/page/n0/annotation",
                            "@type": "oa:Annotation",
                            "motivation": "sc:painting",
                            "on": "https://archive.org/download/zoologische-verhandelingen-91-001-034/page/n0",
                            "resource": {
                                "@id": "https://archive.org/download/zoologische-verhandelingen-91-001-034/page/n0_medium.jpg",
                                "@type": "dctypes:Image",
                                "format": "image/jpeg",
                                "width": 500,
                                "height": 689
                            }
                        }
                    ]
 
 */
 		
        
      }
    
  }

  // do stuff	
  output(doc, triples);
}      
         


function couchdb(doc) {
  if (doc['message-format']) {
    if (doc['message-format'] == 'application/xml') {
      message(doc);
    }
  }
}
// END COUCHDB VIEW

		
//----------------------------------------------------------------------------------------
function convert() {
	var json = $('#json').val();
	var doc = JSON.parse(json);
	
	couchdb(doc);
}

	
	</script>		
			

</div>
</body>
</html>			
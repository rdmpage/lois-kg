{"_id":"_design/page","_rev":"4-5dd4abbdc2ea5bbe4e215138d00237d2","views":{"nt":{"map":"/*\n\nShared code\n\n\n*/\n//----------------------------------------------------------------------------------------\n// http://stackoverflow.com/a/25715455\nfunction isObject(item) {\n    return (typeof item === \"object\" && !Array.isArray(item) && item !== null);\n}\n\n//----------------------------------------------------------------------------------------\n// http://stackoverflow.com/a/21445415\nfunction uniques(arr) {\n    var a = [];\n    for (var i = 0, l = arr.length; i < l; i++)\n        if (a.indexOf(arr[i]) === -1 && arr[i] !== '')\n            a.push(arr[i]);\n    return a;\n}\n\n\n//----------------------------------------------------------------------------------------\n// Store a triple with optional language code\nfunction triple(subject, predicate, object, language) {\n    var triple = [];\n    triple[0] = subject;\n    triple[1] = predicate;\n    triple[2] = object;\n\n    if (typeof language === 'undefined') {} else {\n        triple[3] = language;\n    }\n\n    return triple;\n}\n\n//----------------------------------------------------------------------------------------\n// Enclose triple in suitable wrapping for HTML display or triplet output\nfunction wrap(s, html) {\n    if (s) {\n\n        if (s.match(/^(http|urn|_:)/)) {\n            s = s.replace(/\\\\_/g, '_');\n\n            // handle < > in URIs such as SICI-based DOIs\n            s = s.replace(/</g, '%3C');\n            s = s.replace(/>/g, '%3E');\n\n            if (html) {\n                s = '&lt;' + s + '&gt;';\n            } else {\n                s = '<' + s + '>';\n            }\n        } else {\n          if (s.match(/^\".*\"$/)) {\n            // already quoted, but maybe not escaped\n            s = s.replace(/^\"/, '');\n            s = s.replace(/\"$/g, '');\n          }\n          s = '\"' + s.replace(/\"/g, '\\\\\"') + '\"';\n        }\n    }\n    return s;\n}\n\n//----------------------------------------------------------------------------------------\n// https://css-tricks.com/snippets/javascript/htmlentities-for-javascript/\nfunction htmlEntities(str) {\n    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n}\n\n//----------------------------------------------------------------------------------------\nfunction detect_language(s) {\n    var language = null;\n    var matched = 0;\n    var parts = [];\n\n    var regexp = [];\n\n    // https://gist.github.com/ryanmcgrath/982242\n    regexp['ja'] = /[\\u3000-\\u303F]|[\\u3040-\\u309F]|[\\u30A0-\\u30FF]|[\\uFF00-\\uFFEF]|[\\u4E00-\\u9FAF]|[\\u2605-\\u2606]|[\\u2190-\\u2195]|\\u203B/g;\n    // http://hjzhao.blogspot.co.uk/2015/09/javascript-detect-chinese-character.html\n    regexp['zh'] = /[\\u4E00-\\uFA29]/g;\n    // http://stackoverflow.com/questions/32709687/js-check-if-string-contains-only-cyrillic-symbols-and-spaces\n    regexp['ru'] = /[\\u0400-\\u04FF]/g;\n\n    for (var i in regexp) {\n        parts = s.match(regexp[i]);\n\n        if (parts != null) {\n            if (parts.length > matched) {\n                language = i;\n                matched = parts.length;\n            }\n        }\n    }\n\n    // require a minimum matching\n    if (matched < 2) {\n        language = null;\n    }\n\n    return language;\n\n}\n\n\n//----------------------------------------------------------------------------------------\nfunction output(doc, triples) {\n    // CouchDB\n    for (var i in triples) {\n        var s = 0;\n        var p = 1;\n        var o = 2;\n\n        var lang = 3;\n\n        var nquads = wrap(triples[i][s], false) +\n            ' ' + wrap(triples[i][p], false) +\n            ' ' + wrap(triples[i][o], false);\n        if (triples[i][lang]) {\n            nquads += '@' + triples[i][lang];\n        }\n\n        nquads += ' .' + \"\\n\";\n\n        // use cluster_id as the key so triples from different versions are linked together\n        emit(doc._id, nquads);\n        //console.log(nquads);\n    }\n}\n\n\n\n//----------------------------------------------------------------------------------------\n// START COUCHDB VIEW\nfunction message(doc) {\n  var subject_id = doc._id;\n  var triples = [];\n\t\n\t// image\n\ttriples.push(triple(subject_id,\n        'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n        'http://schema.org/ImageObject'));\n\n\n    for (var i in doc.Result) {\n      switch (i) {\n\n         // links to page and image(s)\t\n         \t\t\n        case 'PageUrl':        \n\t\t\t// image\n\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t'http://schema.org/url',\n\t\t\t\tdoc.Result[i]));\n\t\t\tbreak;\n        \n        case 'FullSizeImageUrl':        \n\t\t\t// image\n\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t'http://schema.org/contentUrl',\n\t\t\t\tdoc.Result[i]));\n\t\t\tbreak;\n\n        case 'ThumbnailUrl':        \n\t\t\t// image\n\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t'http://schema.org/thumbnailUrl',\n\t\t\t\tdoc.Result[i]));\n\t\t\tbreak;\n\n        case 'OcrText':        \n\t\t\t// image\n\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t'http://schema.org/text',\n\t\t\t\tdoc.Result[i]));\n        break;\n\t\t/*\n\"PageNumbers\": [\n      {\n        \"Prefix\": \"Page\",\n        \"Number\": \"492\"\n      }\n    ], */\t\t\n\t\t\t\n\t\tcase 'PageNumbers':\n\t\t\tvar name = [];\n\t\t\t\n\t\t\tif (doc.Result[i][0].Prefix) {\n\t\t\t\tname.push(doc.Result[i][0].Prefix);\n\t\t\t}\n\t\t\tif (doc.Result[i][0].Number) {\n\t\t\t\tname.push(doc.Result[i][0].Number);\n\t\t\t}\n\t\t\t\n\t\t\tif (name.length > 0) {\n\t\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t\t'http://schema.org/name',\n\t\t\t\t\tname.join(' ').toString()));\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tbreak;\n \n\n      }\n    }\n\n    output(doc, triples);\n\n  \n}\n\nfunction (doc) {\n\tmessage(doc);\n}\n\n// END COUCHDB VIEW"}},"language":"javascript"}

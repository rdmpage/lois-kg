{
  "_id": "_design/csl",
  "_rev": "9-64bc4caf14c14855c857c1e10d9d91ce",
  "lists": {
    "triples": "function(head,req) { var row; start({ 'headers': { 'Content-Type': 'text/plain' } }); while(row = getRow()) { send(row.value); } }"
  },
  "views": {
    "doi-orcid": {
      "map": "function (doc) {\n  if (doc['message-format']) {\n    if (doc['message-format'] == 'application/vnd.crossref-api-message+json') {\n     // citations\n     for (var i in doc.message.author) {\n       if (doc.message.author[i].ORCID) {\n         var name = '';\n         if (doc.message.author[i].literal) {\n           name = doc.message.author[i].literal;\n         } else {\n           name = doc.message.author[i].given + ' ' + doc.message.author[i].family;\n         }\n          emit(doc.message.DOI, [doc.message.author[i].ORCID.replace(/https?:\\/\\/orcid.org\\//, ''), name, (parseInt(i)+1)]);\n       }    \n     }\n    }\n    \n  if (doc['message-format'] == 'application/vnd.citationstyles.csl+json') {\n    if (doc.message.DOI) {\n      for (var i in doc.message.author) {\n        if (doc.message.author[i].ORCID) {\n          // ignore cases where author is actually all the authors\n          var go = true;\n          if (doc.message.author[i].literal.match(/ and /)) {\n            go = false;\n          }\n          if (go) {\n            emit(doc.message.DOI.toLowerCase(), [doc.message.author[i].ORCID, doc.message.author[i].literal, parseInt(i)+1]);\n          }\n        }\n      }\n    }\n  }    \n    \n  }\n}"
    },
    "nt": {
      "map": "/*\n\nShared code\n\n\n*/\n//----------------------------------------------------------------------------------------\n// http://stackoverflow.com/a/25715455\nfunction isObject(item) {\n  return (typeof item === \"object\" && !Array.isArray(item) && item !== null);\n}\n\n//----------------------------------------------------------------------------------------\n// http://stackoverflow.com/a/21445415\nfunction uniques(arr) {\n  var a = [];\n  for (var i = 0, l = arr.length; i < l; i++)\n    if (a.indexOf(arr[i]) === -1 && arr[i] !== '')\n      a.push(arr[i]);\n  return a;\n}\n\n\n//----------------------------------------------------------------------------------------\n// Store a triple with optional language code\nfunction triple(subject, predicate, object, language) {\n  var triple = [];\n  triple[0] = subject;\n  triple[1] = predicate;\n  triple[2] = object;\n\n  if (typeof language === 'undefined') {} else {\n    triple[3] = language;\n  }\n\n  return triple;\n}\n\n//----------------------------------------------------------------------------------------\n// Enclose triple in suitable wrapping for HTML display or triplet output\nfunction wrap(s, html) {\n  if (s) {\n\n    if (s.match(/^(http|urn|_:)/)) {\n      s = s.replace(/\\\\_/g, '_');\n\n      // handle < > in URIs such as SICI-based DOIs\n      s = s.replace(/</g, '%3C');\n      s = s.replace(/>/g, '%3E');\n\n      if (html) {\n        s = '&lt;' + s + '&gt;';\n      } else {\n        s = '<' + s + '>';\n      }\n    } else {\n      s = '\"' + s.replace(/\"/g, '\\\\\"') + '\"';\n    }\n  }\n  return s;\n}\n\n//----------------------------------------------------------------------------------------\n// https://css-tricks.com/snippets/javascript/htmlentities-for-javascript/\nfunction htmlEntities(str) {\n  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n}\n\n//----------------------------------------------------------------------------------------\nfunction detect_language(s) {\n  var language = null;\n  var matched = 0;\n  var parts = [];\n\n  var regexp = [];\n\n  // https://gist.github.com/ryanmcgrath/982242\n  regexp['ja'] = /[\\u3000-\\u303F]|[\\u3040-\\u309F]|[\\u30A0-\\u30FF]|[\\uFF00-\\uFFEF]|[\\u4E00-\\u9FAF]|[\\u2605-\\u2606]|[\\u2190-\\u2195]|\\u203B/g;\n  // http://hjzhao.blogspot.co.uk/2015/09/javascript-detect-chinese-character.html\n  regexp['zh'] = /[\\u4E00-\\uFA29]/g;\n  // http://stackoverflow.com/questions/32709687/js-check-if-string-contains-only-cyrillic-symbols-and-spaces\n  regexp['ru'] = /[\\u0400-\\u04FF]/g;\n\n  for (var i in regexp) {\n    parts = s.match(regexp[i]);\n\n    if (parts != null) {\n      if (parts.length > matched) {\n        language = i;\n        matched = parts.length;\n      }\n    }\n  }\n\n  // require a minimum matching\n  if (matched < 2) {\n    language = null;\n  }\n\n  return language;\n\n}\n\n//----------------------------------------------------------------------------------------\nfunction output(doc, triples) {\n  // CouchDB\n  for (var i in triples) {\n    var s = 0;\n    var p = 1;\n    var o = 2;\n\n    var lang = 3;\n\n    var nquads = wrap(triples[i][s], false) +\n      ' ' + wrap(triples[i][p], false) +\n      ' ' + wrap(triples[i][o], false);\n    if (triples[i][lang]) {\n      nquads += '@' + triples[i][lang];\n    }\n\n    nquads += ' .' + \"\\n\";\n\n    // use cluster_id as the key so triples from different versions are linked together\n    emit(doc._id, nquads);\n    //console.log(nquads);\n  }\n}\n\n//----------------------------------------------------------------------------------------\n// START COUCHDB VIEW\nfunction message(doc) {\n  if (doc.message) {\n\n    var subject_id = '';\n    \n    if (subject_id == '')\n    {\n\t\tif (doc.message.DOI) {    \t\n\t\t\tsubject_id = 'https://doi.org/' + doc.message.DOI.toLowerCase();\n\t\t}\n\t}\n\t\n    if (subject_id == '')\n    {\n\t\tif (doc.message.HANDLE) {    \t\n\t\t\tsubject_id = 'https://hdl.handle.net/' + doc.message.HANDLE.toLowerCase();\n\t\t}\n\t}\t\n\n    if (subject_id == '')\n    {\n\t\tif (doc.message.URL) {    \t\n\t\t\tsubject_id = doc.message.URL;\n\t\t}\n\t}\n    \n    var triples = [];\n    var type = '';\n    \n    // handle multilingual keys first so we don't duplicate them\n    \n    // title -----------------------------------------------------------------------------\n    var have_title = false;\n    if (doc.message.multi) {\n    \tif (doc.message.multi._key['title']) {\n    \t\thave_title = true;\n    \t\tfor (var k in doc.message.multi._key['title']) {\n    \t\t\ttriples.push(triple(subject_id,\n\t\t\t\t\t\t'http://schema.org/name',\n\t\t\t\t\t\tdoc.message.multi._key['title'][k], k));\n    \t\t}    \t\n    \t}\n    }\n    \n    if (!have_title) {\n    \tif (doc.message.title) {\n    \t  have_title = true;\n          if (Array.isArray(doc.message.title)) {\n            for (var j in doc.message.title) {\n\n              var lang = detect_language(doc.message.title[j]);\n\n              triples.push(triple(subject_id,\n                'http://schema.org/name',\n                doc.message.title[j], lang));\n            }\n          } else {\n            triples.push(triple(subject_id,\n              'http://schema.org/name',\n              doc.message.title));\n          }\n        }\n    }\n \n    // abstract --------------------------------------------------------------------------\n    var have_abstract = false;\n    if (doc.message.multi) {\n    \tif (doc.message.multi._key['abstract']) {\n    \t\thave_abstract = true;\n    \t\tfor (var k in doc.message.multi._key['abstract']) {\n    \t\t\ttriples.push(triple(subject_id,\n\t\t\t\t\t\t'http://schema.org/description',\n\t\t\t\t\t\tdoc.message.multi._key['abstract'][k], k));\n    \t\t}    \t\n    \t}\n    }\n    \n    if (!have_abstract) {\n    \tif (doc.message['abstract']) {\n    \t\thave_abstract = true;\n            triples.push(triple(subject_id,\n              'http://schema.org/description',\n              doc.message['abstract']));\n        }\n    }\n \t\n\t\n    // container -------------------------------------------------------------------------\n    var container_id = '';    \n       \n    if (doc.message.ISSN) {\n    \tcontainer_id = 'http://worldcat.org/issn/' + doc.message.ISSN[0];\n    \t\n\t  triples.push(triple(container_id,\n\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t'http://schema.org/Periodical'));\n    \t\n    } else {\n    \tcontainer_id = $subject_id + '#container';\n    }\n    \n    \n    if (container_id != '') {\n    \ttriples.push(triple(subject_id,\n              'http://schema.org/isPartOf',\n              container_id));\n              \n        var have_container_title = false;      \n           \n          \n\t\tif (doc.message.multi) {\n\t\t\tif (doc.message.multi._key['container-title']) {\n\t\t\t\thave_container_title = true;\n\t\t\t\tfor (var k in doc.message.multi._key['container-title']) {\n\t\t\t\t\ttriples.push(triple(container_id,\n\t\t\t\t\t\t\t'http://schema.org/name',\n\t\t\t\t\t\t\tdoc.message.multi._key['container-title'][k], k));\n\t\t\t\t}    \t\n\t\t\t}\n\t\t}\n\t    \n\t\tif (!have_container_title) {\n\t\t\tif (doc.message['container-title']) {\n\t\t\t\thave_container_title = true;\n\t\t\t\t\n\t\t\t\tif (Array.isArray(doc.message['container-title'])) {\n           \t\t\tfor (var j in doc.message['container-title']) {\n \t          \t\t\ttriples.push(triple(container_id,\n\t\t\t\t\t\t  'http://schema.org/name',\n\t\t\t\t\t\t  doc.message['container-title'][j]));  \n           \t\t\t}\n           \t\t} else {\n\t\t\t\t\ttriples.push(triple(container_id,\n\t\t\t\t\t  'http://schema.org/name',\n\t\t\t\t\t  doc.message['container-title']));           \t\t\n           \t\t}\n\t\t\t}\n\t\t} \n\t\t            \n    }\n\n    for (var i in doc.message) {\n      switch (i) {\n      \n      \t// identifiers\n        case 'DOI':\n      \t\tvar identifier_id = subject_id + '#doi';\n      \t\t\n      \t\ttriples.push(triple(subject_id,\n              'http://schema.org/identifier',\n              identifier_id));\n\n      \t\ttriples.push(triple(identifier_id,\n              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n              'http://schema.org/PropertyValue'));\n\n      \t\ttriples.push(triple(identifier_id,\n              'http://schema.org/propertyID',\n              'doi'));\n \n      \t\ttriples.push(triple(identifier_id,\n              'http://schema.org/value',\n              doc.message[i].toLowerCase()));\n\t\t\tbreak;   \n\t\t\t\n\t\t// Handle, JSTOR, etc.\n     \t// identifiers\n        case 'HANDLE':\n      \t\tvar identifier_id = subject_id + '#handle';\n      \t\t\n      \t\ttriples.push(triple(subject_id,\n              'http://schema.org/identifier',\n              identifier_id));\n\n      \t\ttriples.push(triple(identifier_id,\n              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n              'http://schema.org/PropertyValue'));\n\n      \t\ttriples.push(triple(identifier_id,\n              'http://schema.org/propertyID',\n              'handle'));\n \n      \t\ttriples.push(triple(identifier_id,\n              'http://schema.org/value',\n              doc.message[i].toLowerCase()));\n\t\t\tbreak;   \n\t\t\n\n/*\n        case 'DOI':\n          triples.push(triple(subject_id,\n            'http://schema.org/identifier',\n            'http://identifiers.org/doi/' + doc.message[i].toLowerCase()));\n          break;\n\n        case 'URL':\n          triples.push(triple(subject_id,\n            'http://schema.org/url',\n            doc.message[i]));\n          break;\n          \n        case 'alternative-id':\n\t\t\tfor (var j in doc.message[i]) {\n\t\t\t  triples.push(triple(subject_id,\n\t\t\t\t'http://schema.org/identifier',\n\t\t\t\tdoc.message[i][j]));\n\t\t\t}\n\t\t\tbreak;  \n*/\t\t\t    \n\t\t\t\n\t\tcase 'type':\n\t\t\tswitch (doc.message[i]) {\n\t\t\t  case 'article-journal':\n\t\t\t  case 'journal-article':\n\t\t\t    type = 'http://schema.org/ScholarlyArticle';\n\t\t\t\tbreak;\n\t\t\t  default:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\n\t\t\t// article metadata\n\t\t  case 'issue':\n\t\t\ttriples.push(triple(subject_id,\n\t\t\t  'http://schema.org/issueNumber',\n\t\t\t  doc.message[i]));\n\t\t\tbreak;\n\n\t\t  case 'pages':\n\t\t\ttriples.push(triple(subject_id,\n\t\t\t  'http://schema.org/pagination',\n\t\t\t  doc.message[i]));\n\t\t\tbreak;\n\n\t\t  case 'volume':\n\t\t\ttriples.push(triple(subject_id,\n\t\t\t  'http://schema.org/volumeNumber',\n\t\t\t  doc.message[i]));\n\t\t\tbreak;\n\t\t\n\t\t  case 'page':\n\t\t\tvar parts = doc.message[i].match(/^(.*)\\-(.*)$/);\n\t\t\tif (parts) {\n\t\t\t  triples.push(triple(subject_id,\n\t\t\t\t'http://schema.org/pageStart',\n\t\t\t\tparts[1]));\n\t\t\t  triples.push(triple(subject_id,\n\t\t\t\t'http://schema.org/pageEnd',\n\t\t\t\tparts[2]));\n\t\t\t} else {\n\t\t\t  triples.push(triple(subject_id,\n\t\t\t\t'http://schema.org/pagination',\n\t\t\t\tdoc.message[i]));\n\t\t\t}\n\t\t\tbreak;\n\t\t\n\t  case 'issued':\n\t     var date = '';\n\t     var dateparts = doc.message[i]['date-parts'][0];\n\t     \n\t     switch (dateparts.length) {\n\t        case 1:\n\t           date = dateparts[0];\n\t           break;\n\t        case 2:\n\t           date = dateparts[0] + '-' + (\"00\" + dateparts[1]).slice(-2) + '-00';\n\t           break;\n\t        case 3:\n\t           date = dateparts[0] + '-' + (\"00\" + dateparts[1]).slice(-2) + '-' + (\"00\" + dateparts[2]).slice(-2);\t           \n\t           break;\n\t        default:\n\t        \tbreak;\n\t    }\n\t    triples.push(triple(subject_id,\n          'http://schema.org/datePublished',\n          date.toString()));\t    \n\t    break;\n                   \n\t\t\t// tags\n\t\t  case 'subject':\n\t\t\tfor (var j in doc.message[i]) {\n\t\t\t  triples.push(triple(subject_id,\n\t\t\t\t'http://schema.org/keywords',\n\t\t\t\tdoc.message[i][j]));\n\t\t\t}\n\t\t\tbreak;\n\t\t\t\n\t\t\t// license\n\t\t  case 'license':\n\t\t\tfor (var j in doc.message[i]) {\n\t\t\t  if (doc.message[i][j].URL) {\n\t\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t  'http://schema.org/license',\n\t\t\t\t  doc.message[i][j].URL));\n\t\t\t  }\n\t\t\t}\n\t\t\tbreak;\n\t\t\t\n\t\t\t// publisher\n\t\t\t// should this be linked to journal rather than article?\n\t\t\t// should this be an object rather than a string?\n\t\t  case 'publisher':\n\t\t\ttriples.push(triple(subject_id,\n\t\t\t  'http://schema.org/publisher',\n\t\t\t  doc.message[i]));\n\t\t\tbreak;\n\t\t\t\n\t\t  case 'ISSN':\n\t\t\t  // ISSNs\n\t\t\tfor (var j in doc.message[i]) {\n\t\t\t  // issn\n\t\t\t  triples.push(triple(container_id,\n\t\t\t\t'http://schema.org/issn',\n\t\t\t\tdoc.message[i][j]));\n\t\t\t}\n\t\t\tbreak;\n\t\t\t\t\t\t\n\t\t\t// authors (may include ORCIDs or possibly other identifiers)\n\t\t\t// create an identifier to make this addressable\n\t\t  case 'author':\n\t\t\tvar n = doc.message[i].length;\n\t\t\t\t\t\t\n\t\t\tfor (var j = 0; j < n; j++) {\n\t\t\t\tvar index = parseInt(j) + 1;\n            \tvar role_id    = subject_id + '#role/' + index;            \t\n            \tvar creator_id = subject_id + '#creator/' + index;\n            \t\n            \t// role\n\t\t\t\ttriples.push(triple(\n\t\t\t\t\tsubject_id,\n\t\t\t\t\t'http://schema.org/creator',\n\t\t\t\t\trole_id)\n\t\t\t\t\t);\n\n\t\t\t\ttriples.push(triple(\n\t\t\t\t\trole_id,\n\t\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t\t'http://schema.org/Role')\n\t\t\t\t\t);\n\n\t\t\t\ttriples.push(triple(\n\t\t\t\t\trole_id,\n\t\t\t\t\t'http://schema.org/roleName',\n\t\t\t\t\tString(index)\n\t\t\t\t\t));\n\n\t\t\t\ttriples.push(triple(\n\t\t\t\t\trole_id,\n\t\t\t\t\t'http://schema.org/creator',\n\t\t\t\t\tcreator_id\n\t\t\t\t\t));            \t\n\t\t\t\t\n\t\t\t\t // creator \n\t\t\t\t\n\t\t\t\t  // type, need to handle organisations as authors\n\t\t\t\t  triples.push(triple(\n\t\t\t\t\tcreator_id,\n\t\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t\t'http://schema.org/Person'));\n\t\t\t\t\t\t\t\t\n\t\t\t\t  // name, which may be multilingual                \n\t\t\t\t\tif (doc.message[i][j]['multi']) {\n\t\t\t\t\t  if (doc.message[i][j]['multi']._key['literal']) {\n\t\t\t\t\t\tfor (var k in doc.message[i][j]['multi']._key['literal']) {\t\t\t\t  \n\t\t\t\t\t\t  triples.push(triple(creator_id,\n\t\t\t\t\t\t\t'http://schema.org/name',\n\t\t\t\t\t\t\tdoc.message[i][j]['multi']._key['literal'][k], k));  \n\t\t\t\t\t\t}\n\t\t\t\t\t  }\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// one or more strings\n\t\t\t\t\t\t\n\t\t\t\t\t   var person_name;\n\t\t\t\t\t\tif (doc.message[i][j].literal) {\n\t\t\t\t\t\t  person_name = doc.message[i][j].literal;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t  var parts = [];\n\t\t\t\t\t\t  if (doc.message[i][j].given) {\n\t\t\t\t\t\t\tparts.push(doc.message[i][j].given); \n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\ttriples.push(triple(creator_id,\n\t\t\t\t  \t\t\t\t'http://schema.org/givenName', // ?\n\t\t\t\t  \t\t\t\tdoc.message[i][j].given));\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t  if (doc.message[i][j].family) {\n\t\t\t\t\t\t\tparts.push(doc.message[i][j].family); \n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\ttriples.push(triple(creator_id,\n\t\t\t\t  \t\t\t\t'http://schema.org/familyName', // ?\n\t\t\t\t  \t\t\t\tdoc.message[i][j].family));\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t  person_name = parts.join(' ');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t  triples.push(triple(\n\t\t\t\t\t\tcreator_id,\n\t\t\t\t\t\t'http://schema.org/name',\n\t\t\t\t\t\tperson_name));\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t} \n\t\t\t\t\t\n\t\t\t\t\t// identifier(s)\n\t\t\t\t\tif (doc.message[i][j].ORCID) {\n\t\t\t\t\t\tvar identifier_id = creator_id + '-orcid';\n\t           \t\t\tvar orcid = doc.message[i][j].ORCID;\n            \t\t\torcid = orcid.replace(/https?:\\/\\/orcid.org\\//, '');\n            \t\t\t\n\t\t\t\t\t\ttriples.push(triple(\n\t\t\t\t\t\t  creator_id,\n\t\t\t\t\t\t  'http://schema.org/identifier',\n\t\t\t\t\t\t  identifier_id));\n\t\t\t\t\t\t\n\t\t\t\t\t\ttriples.push(triple(\n\t\t\t\t\t\t  identifier_id,\n\t\t\t\t\t\t  'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t\t\t  'http://schema.org/PropertyValue'));\n\n\t\t\t\t\t\ttriples.push(triple(\n\t\t\t\t\t\t  identifier_id,\n\t\t\t\t\t\t  'http://schema.org/propertyID',\n\t\t\t\t\t\t  'orcid'));\n\n\t\t\t\t\t\ttriples.push(triple(\n\t\t\t\t\t\t  identifier_id,\n\t\t\t\t\t\t  'http://schema.org/value',\n\t\t\t\t\t\t  orcid\n\t\t\t\t\t\t));                          \t\t\t            \t\t\t\n            \t\t}\n\t\n\t\t\t}\n\t\t\tbreak;\t\n\t\t\t\t\n\t\t\t\n          /*\n\t\t\t// funding\n\t\t  case 'funder':\n\t\t\tvar n = doc.message[i].length;\n\t\t\tfor (var j = 0; j < n; j++) {\n\t\t\t  var funder_id = '';\n\n\t\t\t  // create identifier for funder\n\t\t\t  if (doc.message[i][j].DOI) {\n\t\t\t\tfunder_id = 'http://identifiers.org/doi/' + doc.message[i][j].DOI;\n\t\t\t  } else {\n\t\t\t\t// #hash identifier \n\t\t\t\tfunder_id = subject_id + '#funder_' + (j + 1);\n\t\t\t  }\n\n\t\t\t  // create funder \n\t\t\t  triples.push(triple(funder_id,\n\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t'http://schema.org/Organisation'));\n\n\t\t\t  triples.push(triple(funder_id,\n\t\t\t\t'http://schema.org/name',\n\t\t\t\tdoc.message[i][j].name));\n\n\t\t\t  // role\n\t\t\t  var m = doc.message[i][j].award.length;\n\n\t\t\t  if (m == 0) {\n\t\t\t\t// funder but award not known\n\t\t\t\tvar award_id = funder_id + '/award';\n\n\t\t\t\ttriples.push(triple(award_id,\n\t\t\t\t  'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t  'http://schema.org/Role'));\n\n\t\t\t\t// link to funder \n\t\t\t\ttriples.push(triple(award_id,\n\t\t\t\t  'http://schema.org/funder',\n\t\t\t\t  funder_id));\n\n\t\t\t\t// link role to work         \n\t\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t  'http://schema.org/funder',\n\t\t\t\t  award_id));\n\t\t\t  } else {\n\t\t\t\t// we have one or more awards\n\t\t\t\tfor (var a = 0; a < m; a++) {\n\t\t\t\t  var award_id = funder_id + '/award_' + (a+1);\n\n\t\t\t\t  triples.push(triple(award_id,\n\t\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t\t'http://schema.org/Role'));\n\n\t\t\t\t  triples.push(triple(award_id,\n\t\t\t\t\t'http://schema.org/roleName',\n\t\t\t\t\tdoc.message[i][j].award[a]\n\t\t\t\t  ));\n\n\t\t\t\t  // link to funder \n\t\t\t\t  triples.push(triple(award_id,\n\t\t\t\t\t'http://schema.org/funder',\n\t\t\t\t\tfunder_id));\n\n\t\t\t\t  // link role to work         \n\t\t\t\t  triples.push(triple(subject_id,\n\t\t\t\t\t'http://schema.org/funder',\n\t\t\t\t\taward_id));\n\t\t\t\t}\n\t\t\t  }\n\t\t\t}\n\t\t\tbreak;\n\t\t\t*/\n\t\t\t\n\t\t\t/*\n\n\t\t\t// links to representions such as PDFs, XML, HTML, etc.\n\t\t\t// may be links to text mining sources\n\t\t  case 'link':\n\t\t\tvar n = doc.message[i].length;\n\t\t\tfor (var j = 0; j < n; j++) {\n\t\t\t  var link_id = subject_id + '#link_' + (j + 1);\n\n\t\t\t  // type\n\t\t\t  triples.push(triple(link_id,\n\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t'http://schema.org/CreativeWork'));\n\n\t\t\t  if (doc.message[i][j].URL) {\n\t\t\t\ttriples.push(triple(link_id,\n\t\t\t\t  'http://schema.org/url',\n\t\t\t\t  doc.message[i][j].URL));\n\n\t\t\t\tif (doc.message[i][j]['content-type']) {\n\t\t\t\t  triples.push(triple(link_id,\n\t\t\t\t\t'http://schema.org/fileFormat',\n\t\t\t\t\tdoc.message[i][j]['content-type']));\n\t\t\t\t}\n\n\t\t\t\t// link to work\n\t\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t  'http://schema.org/workExample',\n\t\t\t\t  link_id));\n\t\t\t  }\n\t\t\t}\n\t\t\tbreak;\n\t\t\t\n\t\t*/\n\n\n/*\n      \"reference\": [\n           {\n               \"key\": \"11192_B1\",\n               \"first-page\": \"119\",\n               \"article-title\": \"Pseudocrangonyx, a new genus of subterranean amphipods from Japan.\",\n               \"volume\": \"10\",\n               \"author\": \"Akatsuka\",\n               \"year\": \"1922\",\n               \"journal-title\": \"Annotationes Zoologicae Japonenses\"\n           },\n */\n \n \n \t\t  case 'reference':\n\t\t\tvar n = doc.message[i].length;\n\t\t\tfor (var j = 0; j < n; j++) {\n\t\t\t  \n\t\t\t  // use key as identifier, but clean first\n\t\t\t  var key = doc.message[i][j].key;\n\t\t\t  \n                key = key.replace(/\\t/g, '');\n                key = key.replace(/\\n/g, '');\n\n                // replace characters not allowed\n                key = key.replace(/\\|/g, '-');\n                key = key.replace(/\\//g, '-');\n                key = key.replace(/\\./g, '-');\n                key = key.replace(/\\s/g, '-');\n\t\n\t\t\t\n\t\t\t  var reference_id = subject_id + '#' + key;\n\t\t\t  \n \t\t\t\t// link to work\n\t\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t  'http://schema.org/citation',\n\t\t\t\t  reference_id));\n\t\t\t  \n\t\t\t  // type\n\t\t\t  triples.push(triple(reference_id,\n\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t'http://schema.org/CreativeWork'));\n\n\n               // DOI?\n               if (doc.message[i][j].DOI) {\n \t\t\t\t  // DOI cleaning (sigh)\n\t\t\t\t  /* Sometimes publishes make a mess of this, e.g. \n\t\t\t\t  http://dx.doi.org/10.1111/j.1096-0031.2007.00176.x\n\t\t\t\t  {\n\t\t\t\t\tkey: \"b129_103\",\n\t\t\t\t\tDOI: \"10.1636/H05-14 SC.1\",\n\t\t\t\t\tdoi-asserted-by: \"publisher\"\n\t\t\t\t  }\n\t\t\t\t  */\n\t\t\t\t  var doi = doc.message[i][j].DOI;\n\t\t\t\t  doi = doi.replace(/sc.1?/g, '');\n\t\t\t\t  doi = doi.replace(/\\s/g, ''); \n\t\t\t\t  doi = doi.toLowerCase(); \n\t\t\t\t  \n                 var identifier_id = reference_id + '#doi';\n                              \n\t\t\t\t  triples.push(triple(reference_id,\n\t\t\t\t\t'http://schema.org/identifier',\n\t\t\t\t\tidentifier_id));\n\t\t\t\t\t\n\t\t\t\t triples.push(triple(identifier_id,\n\t\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t\t'http://schema.org/PropertyValue'));\n\n\t\t\t\t  triples.push(triple(identifier_id,\n\t\t\t\t\t'http://schema.org/propertyID',\n\t\t\t\t\t'doi'));\n\n\t\t\t\t  triples.push(triple(identifier_id,\n\t\t\t\t\t'http://schema.org/value',\n\t\t\t\t\tdoc.message[i][j].DOI.toLowerCase()\n\t\t\t\t  ));\n\t\t\t\t              \n\t\t\t\t  \n\t\t\t\t\t\n\t\t\t\t \t\t\t  \t\t\t\t\t\t\n\t\t\t\t}  \n\t\t\t\t\n\t\t\t\t// unstructured?\n                if (doc.message[i][j].unstructured) {\n                \tvar text = doc.message[i][j].unstructured;\n                \ttext = text.replace(/\\n/g, '');\n\t\t\t\t  triples.push(triple(reference_id,\n\t\t\t\t\t'http://schema.org/description',\n\t\t\t\t\ttext\n\t\t\t\t\t));\n\t\t\t\t}               \n\t\t\t\t\t\n\t\t\t\t// metadata\n               if (doc.message[i][j].author) {\n\t\t\t\t  triples.push(triple(reference_id,\n\t\t\t\t\t'http://schema.org/creator',\n\t\t\t\t\tdoc.message[i][j].author));\n\t\t\t\t}               \n\t\t\t\t\n\t\t\t\t\n               if (doc.message[i][j]['article-title']) {\n\t\t\t\t  triples.push(triple(reference_id,\n\t\t\t\t\t'http://schema.org/name',\n\t\t\t\t\tdoc.message[i][j]['article-title']));\n\t\t\t\t}               \n\t\t\t\t\n\t\t\t\t// non schema\n                if (doc.message[i][j]['journal-title']) {\n               \t\tvar container_id = reference_id + '-container';\n               \t\t\n  \t\t\t\t  triples.push(triple(reference_id,\n\t\t\t\t\t'http://schema.org/isPartOf',\n\t\t\t\t\tcontainer_id));\n\n \t\t\t\t  triples.push(triple(container_id,\n\t\t\t\t\t'http://schema.org/name',\n\t\t\t\t\tdoc.message[i][j]['journal-title']\n\t\t\t\t\t));\n\t\t\t\t} \n               if (doc.message[i][j].volume) {\n\t\t\t\t  triples.push(triple(reference_id,\n\t\t\t\t\t'http://schema.org/volumeNumber',\n\t\t\t\t\tdoc.message[i][j].volume));\n\t\t\t\t}               \t\t\t\t             \n               if (doc.message[i][j]['first-page']) {\n\t\t\t\t  triples.push(triple(reference_id,\n\t\t\t\t\t'http://schema.org/pageStart',\n\t\t\t\t\tdoc.message[i][j]['first-page']));\n\t\t\t\t}               \n               if (doc.message[i][j].year) {\n               \t\tvar year = doc.message[i][j].year;\n                \tyear = year.replace(/[a-z]$/, '');\n\t\t\t\t  triples.push(triple(reference_id,\n\t\t\t\t\t'http://schema.org/datePublished',\n\t\t\t\t\tyear));\n\t\t\t\t}               \n\t\t\t\t             \n\t\t\t  }\n\t\t\t\n\t\t\tbreak;\n  \n\t\t\t\n\n        default:\n          break;\n      }\n    }\n\n    if (type == '') {\n      type = 'http://schema.org/CreativeWork';\n    }\n    \n\n    // defaults\n    triples.push(triple(subject_id,\n      'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n      type));\n\n    output(doc, triples);\n  }\n}\n\nfunction (doc) {\n  if (doc['message-format']) {\n    if (doc['message-format'] == 'application/vnd.crossref-api-message+json') {\n      message(doc);\n    }\n  }\n}\n// END COUCHDB VIEW\n"
    }
  },
  "language": "javascript"
}

{"_id":"_design/work","_rev":"17-adf040c3a5b2af945083bed8422b7753","lists":{"triples":"function(head,req) { var row; start({ 'headers': { 'Content-Type': 'text/plain' } }); while(row = getRow()) { send(row.value); } }"},"views":{"nt":{"map":"/*\n\nShared code\n\n\n*/\n//----------------------------------------------------------------------------------------\n// http://stackoverflow.com/a/25715455\nfunction isObject(item) {\n  return (typeof item === \"object\" && !Array.isArray(item) && item !== null);\n}\n\n//----------------------------------------------------------------------------------------\n// http://stackoverflow.com/a/21445415\nfunction uniques(arr) {\n  var a = [];\n  for (var i = 0, l = arr.length; i < l; i++)\n    if (a.indexOf(arr[i]) === -1 && arr[i] !== '')\n      a.push(arr[i]);\n  return a;\n}\n\n\n//----------------------------------------------------------------------------------------\n// Store a triple with optional language code\nfunction triple(subject, predicate, object, language) {\n  var triple = [];\n  triple[0] = subject;\n  triple[1] = predicate;\n  triple[2] = object;\n\n  if (typeof language === 'undefined') {}\n  else {\n    triple[3] = language;\n  }\n\n  return triple;\n}\n\n//----------------------------------------------------------------------------------------\n// Enclose triple in suitable wrapping for HTML display or triplet output\nfunction wrap(s, html) {\n  if (s) {\n\n    if (s.match(/^(http|urn|_:)/)) {\n      s = s.replace(/\\\\_/g, '_');\n\n      // handle < > in URIs such as SICI-based DOIs\n      s = s.replace(/</g, '%3C');\n      s = s.replace(/>/g, '%3E');\n\n      if (html) {\n        s = '&lt;' + s + '&gt;';\n      }\n      else {\n        s = '<' + s + '>';\n      }\n    }\n    else {\n      if (s.match(/^\".*\"$/)) {\n        // already quoted, but maybe not escaped\n        s = s.replace(/^\"/, '');\n        s = s.replace(/\"$/g, '');\n      }\n      s = '\"' + s.replace(/\"/g, '\\\\\"') + '\"';\n\n    }\n  }\n  return s;\n}\n\n//----------------------------------------------------------------------------------------\n// https://css-tricks.com/snippets/javascript/htmlentities-for-javascript/\nfunction htmlEntities(str) {\n  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n}\n\n//----------------------------------------------------------------------------------------\nfunction detect_language(s) {\n  var language = null;\n  var matched = 0;\n  var parts = [];\n\n  var regexp = [];\n\n  // https://gist.github.com/ryanmcgrath/982242\n  regexp['ja'] = /[\\u3000-\\u303F]|[\\u3040-\\u309F]|[\\u30A0-\\u30FF]|[\\uFF00-\\uFFEF]|[\\u4E00-\\u9FAF]|[\\u2605-\\u2606]|[\\u2190-\\u2195]|\\u203B/g;\n  // http://hjzhao.blogspot.co.uk/2015/09/javascript-detect-chinese-character.html\n  regexp['zh'] = /[\\u4E00-\\uFA29]/g;\n  // http://stackoverflow.com/questions/32709687/js-check-if-string-contains-only-cyrillic-symbols-and-spaces\n  regexp['ru'] = /[\\u0400-\\u04FF]/g;\n\n  for (var i in regexp) {\n    parts = s.match(regexp[i]);\n\n    if (parts != null) {\n      if (parts.length > matched) {\n        language = i;\n        matched = parts.length;\n      }\n    }\n  }\n\n  // require a minimum matching\n  if (matched < 2) {\n    language = null;\n  }\n\n  return language;\n\n}\n\n//----------------------------------------------------------------------------------------\nfunction finger_print(s) {\n  s = s.toLowerCase();\n\n  // stop words\n  // en\n  s = s.replace(/\\bfor\\b/g, '');\n  s = s.replace(/\\band\\b/g, '')\n  s = s.replace(/\\bof\\b/g, '');\n  s = s.replace(/\\bthe\\b/g, '');\n  s = s.replace(/\\bin\\b/g, '');\n\n  // fr\n  s = s.replace(/\\bde\\b/g, '');\n  s = s.replace(/\\bla\\b/g, '');\n  s = s.replace(/\\bet\\b/g, '');\n\n  // de\n  s = s.replace(/\\bdas\\b/g, '');\n  s = s.replace(/\\bder\\b/g, '');\n  s = s.replace(/\\bfur\\b/g, '');\n\n  // numbers\n  s = s.replace(/\\d+/g, '');\n\n\n  // white space\n  s = s.replace(/\\s\\s*/g, '');\n\n  // punctuation\n  s = s.replace(/[\\.|,|\\'|\\(|\\)|\"|:|-|&|-]+/g, '');\n\n  return s;\n}\n\n//----------------------------------------------------------------------------------------\nfunction output(doc, triples) {\n  // CouchDB\n  for (var i in triples) {\n    var s = 0;\n    var p = 1;\n    var o = 2;\n\n    var lang = 3;\n\n    var nquads = wrap(triples[i][s], false) +\n      ' ' + wrap(triples[i][p], false) +\n      ' ' + wrap(triples[i][o], false);\n    if (triples[i][lang]) {\n      nquads += '@' + triples[i][lang];\n    }\n\n    nquads += ' .' + \"\\n\";\n\n    // use cluster_id as the key so triples from different versions are linked together\n    emit(doc._id, nquads);\n    //console.log(nquads);\n  }\n}\n\n//----------------------------------------------------------------------------------------\n// START COUCHDB VIEW\nfunction message(doc) {\n  if (doc.message) {\n\n    var subject_id = '';\n\n    if (subject_id == '') {\n      if (doc.message.DOI) {\n        subject_id = 'https://doi.org/' + doc.message.DOI.toLowerCase();\n      }\n    }\n\n    if (subject_id == '') {\n      if (doc.message.HANDLE) {\n        subject_id = 'https://hdl.handle.net/' + doc.message.HANDLE.toLowerCase();\n      }\n    }\n\n    if (subject_id == '') {\n      if (doc.message.JSTOR) {\n        subject_id = 'https://www.jstor.org/stable/' + doc.message.JSTOR;\n      }\n    }\n\n    if (subject_id == '') {\n      if (doc.message.URL) {\n        subject_id = doc.message.URL;\n      }\n    }\n\n    if (subject_id == '') {\n      if (doc.message.PMID) {\n        subject_id = 'https://www.ncbi.nlm.nih.gov/pubmed/' + doc.message.PMID;\n      }\n    }\n\n    // HTTPS\n    if (subject_id.match(/^http:\\/\\/(www\\.)?jstor/)) {\n      subject_id = subject_id.replace(/^http:/, 'https:');\n    }\n\n    var triples = [];\n    var type = '';\n\n    // handle multilingual keys first so we don't duplicate them\n\n    // title -----------------------------------------------------------------------------\n    var have_title = false;\n    if (doc.message.multi) {\n      if (doc.message.multi._key['title']) {\n        have_title = true;\n        for (var k in doc.message.multi._key['title']) {\n          triples.push(triple(subject_id,\n            'http://schema.org/name',\n            doc.message.multi._key['title'][k], k));\n        }\n      }\n    }\n\n    if (!have_title) {\n      if (doc.message.title) {\n        have_title = true;\n        if (Array.isArray(doc.message.title)) {\n          for (var j in doc.message.title) {\n\n            var lang = detect_language(doc.message.title[j]);\n\n            triples.push(triple(subject_id,\n              'http://schema.org/name',\n              doc.message.title[j], lang));\n          }\n        }\n        else {\n          triples.push(triple(subject_id,\n            'http://schema.org/name',\n            doc.message.title));\n        }\n      }\n    }\n\n    // abstract --------------------------------------------------------------------------\n    var have_abstract = false;\n    if (doc.message.multi) {\n      if (doc.message.multi._key['abstract']) {\n        have_abstract = true;\n        for (var k in doc.message.multi._key['abstract']) {\n          triples.push(triple(subject_id,\n            'http://schema.org/description',\n            doc.message.multi._key['abstract'][k], k));\n        }\n      }\n    }\n\n    if (!have_abstract) {\n      if (doc.message['abstract']) {\n        have_abstract = true;\n\n        var abstract_text = doc.message['abstract'];\n\n        // fix JATS tags\n        abstract_text = abstract_text.replace(/<jats:title>/g, ' <i>');\n        abstract_text = abstract_text.replace(/<\\/jats:title>/g, '</i>');\n        abstract_text = abstract_text.replace(/<jats:p>/g, '<p>');\n        abstract_text = abstract_text.replace(/<\\/jats:p>/g, '</p>');\n        abstract_text = abstract_text.replace(/<jats:italic>/g, ' <i>');\n        abstract_text = abstract_text.replace(/<\\/jats:italic>/g, '</i>');\n\n        triples.push(triple(subject_id,\n          'http://schema.org/description',\n          abstract_text));\n      }\n    }\n\n\n    // container -------------------------------------------------------------------------\n    var container_id = '';\n\n    if (doc.message.ISSN) {\n      container_id = 'http://worldcat.org/issn/' + doc.message.ISSN[0];\n\n      triples.push(triple(container_id,\n        'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n        'http://schema.org/Periodical'));\n\n    }\n    else {\n      container_id = subject_id + '#container';\n    }\n\n\n    if (container_id != '') {\n      triples.push(triple(subject_id,\n        'http://schema.org/isPartOf',\n        container_id));\n\n      var have_container_title = false;\n\n\n      if (doc.message.multi) {\n        if (doc.message.multi._key['container-title']) {\n          have_container_title = true;\n\n          var schema_term = 'http://schema.org/name';\n          if (doc.message.ISSN) {\n            schema_term = 'http://schema.org/alternateName';\n          }\n\n          for (var k in doc.message.multi._key['container-title']) {\n            triples.push(triple(container_id,\n              schema_term,\n              doc.message.multi._key['container-title'][k], k));\n          }\n        }\n      }\n\n      if (!have_container_title) {\n\n        var schema_term = 'http://schema.org/name';\n        if (doc.message.ISSN) {\n          schema_term = 'http://schema.org/alternateName';\n        }\n\n        if (doc.message['container-title']) {\n          have_container_title = true;\n\n          if (Array.isArray(doc.message['container-title'])) {\n            for (var j in doc.message['container-title']) {\n              triples.push(triple(container_id,\n                schema_term,\n                doc.message['container-title'][j]));\n            }\n          }\n          else {\n            triples.push(triple(container_id,\n              schema_term,\n              doc.message['container-title']));\n          }\n        }\n      }\n\n    }\n\n    for (var i in doc.message) {\n      switch (i) {\n\n        // thumbnail as quoted URL\n        case 'thumbnailUrl':\n          triples.push(triple(subject_id,\n            'http://schema.org/thumbnailUrl',\n            '\"' + doc.message[i] + '\"'));\n          break;\n\n          // identifiers\n        case 'DOI':\n          /*\n          triples.push(triple(subject_id,\n            'http://schema.org/identifier',\n            '\"https://doi.org/' + doc.message[i].toLowerCase() + '\"'));\n        \n        \n        \t*/\n          var identifier_id = subject_id + '#doi';\n\n          triples.push(triple(subject_id,\n            'http://schema.org/identifier',\n            identifier_id));\n\n          triples.push(triple(identifier_id,\n            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n            'http://schema.org/PropertyValue'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/propertyID',\n            'doi'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/value',\n            doc.message[i].toLowerCase()));\n          break;\n\n          // Handle, JSTOR, etc.\n          // identifiers\n        case 'HANDLE':\n          /*\n            triples.push(triple(subject_id,\n              'http://schema.org/identifier',\n              '\"https://hdl.handle.net/' + doc.message[i] + '\"'));\n          \n          */\n          var identifier_id = subject_id + '#handle';\n\n          triples.push(triple(subject_id,\n            'http://schema.org/identifier',\n            identifier_id));\n\n          triples.push(triple(identifier_id,\n            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n            'http://schema.org/PropertyValue'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/propertyID',\n            'handle'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/value',\n            doc.message[i].toLowerCase()));\n          break;\n\n        case 'JSTOR':\n          /*\n            triples.push(triple(subject_id,\n              'http://schema.org/identifier',\n              '\"https://hdl.handle.net/' + doc.message[i] + '\"'));\n          \n          */\n          var identifier_id = subject_id + '#jstor';\n\n          triples.push(triple(subject_id,\n            'http://schema.org/identifier',\n            identifier_id));\n\n          triples.push(triple(identifier_id,\n            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n            'http://schema.org/PropertyValue'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/propertyID',\n            'jstor'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/value',\n            doc.message[i].toLowerCase()));\n          break;\n\n\n        case 'PMID':\n          /*\n            triples.push(triple(subject_id,\n              'http://schema.org/identifier',\n              '\"https://www.ncbi.nlm.nih.gov/pubmed/' + doc.message[i] + '\"'));\n          \n          */\n          var identifier_id = subject_id + '#pmid';\n\n          triples.push(triple(subject_id,\n            'http://schema.org/identifier',\n            identifier_id));\n\n          triples.push(triple(identifier_id,\n            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n            'http://schema.org/PropertyValue'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/propertyID',\n            'pmid'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/value',\n            doc.message[i].toString()));\n          break;\n\n        case 'SICI':\n          /*\n            triples.push(triple(subject_id,\n              'http://schema.org/identifier',\n              '\"urn:sici:' + doc.message[i] + '\"'));\n          \n          */\n          var identifier_id = subject_id + '#sici';\n\n          triples.push(triple(subject_id,\n            'http://schema.org/identifier',\n            identifier_id));\n\n          triples.push(triple(identifier_id,\n            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n            'http://schema.org/PropertyValue'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/propertyID',\n            'sici'));\n\n          triples.push(triple(identifier_id,\n            'http://schema.org/value',\n            doc.message[i]));\n          break;\n\n\n        case 'type':\n          switch (doc.message[i]) {\n            case 'article-journal':\n            case 'journal-article':\n              type = 'http://schema.org/ScholarlyArticle';\n              break;\n            default:\n              break;\n          }\n          break;\n\n          // article metadata\n\n        case 'pages':\n          triples.push(triple(subject_id,\n            'http://schema.org/pagination',\n            doc.message[i]));\n          break;\n\n        case 'volume':\n          if (1) {\n            triples.push(triple(subject_id,\n              'http://schema.org/volumeNumber',\n              doc.message[i]));\n          }\n          else {\n\n            if (container_id != '') {\n              var volume_id = container_id + '#volume';\n\n              triples.push(triple(subject_id,\n                'http://schema.org/isPartOf',\n                volume_id));\n\n              triples.push(triple(volume_id,\n                'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n                'http://schema.org/PublicationVolume'));\n\n              triples.push(triple(volume_id,\n                'http://schema.org/volumeNumber',\n                doc.message[i]));\n            }\n            else {\n              triples.push(triple(subject_id,\n                'http://schema.org/volumeNumber',\n                doc.message[i]));\n            }\n          }\n          break;\n\n        case 'issue':\n          if (1) {\n            triples.push(triple(subject_id,\n              'http://schema.org/issueNumber',\n              doc.message[i]));\n          }\n          else {\n            if (container_id != '') {\n              var issue_id = container_id + '#issue';\n\n              triples.push(triple(subject_id,\n                'http://schema.org/isPartOf',\n                issue_id));\n\n              triples.push(triple(issue_id,\n                'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n                'http://schema.org/PublicationIssue'));\n\n              triples.push(triple(issue_id,\n                'http://schema.org/issueNumber',\n                doc.message[i]));\n            }\n            else {\n              triples.push(triple(subject_id,\n                'http://schema.org/issueNumber',\n                doc.message[i]));\n            }\n          }\n          break;\n\n        case 'page':\n          var parts = doc.message[i].match(/^(.*)\\-(.*)$/);\n          if (parts) {\n            triples.push(triple(subject_id,\n              'http://schema.org/pageStart',\n              parts[1]));\n            triples.push(triple(subject_id,\n              'http://schema.org/pageEnd',\n              parts[2]));\n          }\n          else {\n            triples.push(triple(subject_id,\n              'http://schema.org/pagination',\n              doc.message[i]));\n          }\n          break;\n\n        case 'issued':\n          var date = '';\n          var dateparts = doc.message[i]['date-parts'][0];\n\n          switch (dateparts.length) {\n            case 1:\n              date = dateparts[0];\n              break;\n            case 2:\n              date = dateparts[0] + '-' + (\"00\" + dateparts[1]).slice(-2) + '-00';\n              break;\n            case 3:\n              date = dateparts[0] + '-' + (\"00\" + dateparts[1]).slice(-2) + '-' + (\"00\" + dateparts[2]).slice(-2);\n              break;\n            default:\n              break;\n          }\n          triples.push(triple(subject_id,\n            'http://schema.org/datePublished',\n            date.toString()));\n          break;\n\n          // tags\n        case 'subject':\n          for (var j in doc.message[i]) {\n            triples.push(triple(subject_id,\n              'http://schema.org/keywords',\n              doc.message[i][j]));\n          }\n          break;\n\n          // license\n        case 'license':\n          for (var j in doc.message[i]) {\n            if (doc.message[i][j].URL) {\n              triples.push(triple(subject_id,\n                'http://schema.org/license',\n                doc.message[i][j].URL));\n            }\n          }\n          break;\n\n          // publisher\n          // should this be linked to journal rather than article?\n          // should this be an object rather than a string?\n        case 'publisher':\n          triples.push(triple(subject_id,\n            'http://schema.org/publisher',\n            doc.message[i]));\n          break;\n\n          // need to double check this as it seems to cause chaos\n          /*\n                case 'ISSN':\n                    // ISSNs\n                    for (var j in doc.message[i]) {\n                        // issn\n                        triples.push(triple(container_id,\n                            'http://schema.org/issn',\n                            doc.message[i][j]));\n                    }\n                    break;\n                    */\n\n          // authors (may include ORCIDs or possibly other identifiers)\n          // create an identifier to make this addressable\n        case 'author':\n          var n = doc.message[i].length;\n\n          for (var j = 0; j < n; j++) {\n            var index = parseInt(j) + 1;\n            var role_id = subject_id + '#role-' + index;\n\n            var person_mode = 'local'; // person is always a bnode, with ORCID as sameAs\n            //var person_mode = 'global'; // use ORCIDs as person identifiers when we have them\n\n            var sameAs = [];\n\n            var orcid = '';\n\n            var creator_id = '';\n\n            if (doc.message[i][j].ORCID) {\n              orcid = doc.message[i][j].ORCID;\n              orcid = orcid.replace(/https?:\\/\\/orcid.org\\//, '');\n\n              if (person_mode == 'global') {\n                creator_id = 'https://orcid.org/' + orcid;\n              }\n\n              // store ORCID identifier\n              sameAs.push('https://orcid.org/' + orcid);\n            }\n\n            if (creator_id == '') {\n              creator_id = subject_id + '#creator-' + index;\n            }\n\n            // role\n            triples.push(triple(\n              subject_id,\n              'http://schema.org/creator',\n              role_id));\n\n            triples.push(triple(\n              role_id,\n              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n              'http://schema.org/Role'));\n\n            triples.push(triple(\n              role_id,\n              'http://schema.org/roleName',\n              String(index)\n            ));\n\n            triples.push(triple(\n              role_id,\n              'http://schema.org/creator',\n              creator_id\n            ));\n\n            // creator \n\n            // type, need to handle organisations as authors\n            triples.push(triple(\n              creator_id,\n              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n              'http://schema.org/Person'));\n\n            // name, which may be multilingual                \n            if (doc.message[i][j]['multi']) {\n              if (doc.message[i][j]['multi']._key['literal']) {\n                for (var k in doc.message[i][j]['multi']._key['literal']) {\n                  triples.push(triple(creator_id,\n                    'http://schema.org/name',\n                    doc.message[i][j]['multi']._key['literal'][k], k));\n                }\n              }\n            }\n            else {\n              // one or more strings\n\n              if ((person_mode == 'global') && (sameAs.length > 0)) {\n\n                // We have global identifier for person, so store name as alternateName\n                // on assumption that we have definitive name linked to external id (e.g., ORCID)\n                var person_name;\n\n                if (doc.message[i][j].literal) {\n                  person_name = doc.message[i][j].literal;\n                }\n                else {\n                  var parts = [];\n                  if (doc.message[i][j].given) {\n                    parts.push(doc.message[i][j].given);\n                  }\n                  if (doc.message[i][j].family) {\n                    parts.push(doc.message[i][j].family);\n                  }\n                  person_name = parts.join(' ');\n                }\n\n                // store name as alternate name\n                triples.push(triple(creator_id,\n                  'http://schema.org/alternateName',\n                  person_name));\n\n\n              }\n              else {\n                // store name locally\n                var person_name;\n                if (doc.message[i][j].literal) {\n                  person_name = doc.message[i][j].literal;\n                }\n                else {\n                  var parts = [];\n                  if (doc.message[i][j].given) {\n                    parts.push(doc.message[i][j].given);\n\n                    triples.push(triple(creator_id,\n                      'http://schema.org/givenName', // ?\n                      doc.message[i][j].given));\n\n                  }\n                  if (doc.message[i][j].family) {\n                    parts.push(doc.message[i][j].family);\n\n                    triples.push(triple(creator_id,\n                      'http://schema.org/familyName', // ?\n                      doc.message[i][j].family));\n\n                  }\n                  person_name = parts.join(' ');\n                }\n\n                triples.push(triple(\n                  creator_id,\n                  'http://schema.org/name',\n                  person_name));\n              }\n\n            }\n\n            // identifier(s)\n            for (var k in sameAs) {\n              triples.push(triple(creator_id,\n                'http://schema.org/sameAs',\n                '\"' + sameAs[k] + '\"'));\n            }\n\n\n\n            /*\n            if (doc.message[i][j].ORCID) {\n\n              var identifier_id = '';\n\n              if (use_orcid) {\n                identifier_id = creator_id + '#orcid';\n              }\n              else {\n                identifier_id = creator_id + '-orcid';\n              }\n              var orcid = doc.message[i][j].ORCID;\n              orcid = orcid.replace(/https?:\\/\\/orcid.org\\//, '');\n\n              triples.push(triple(\n                creator_id,\n                'http://schema.org/identifier',\n                identifier_id));\n\n              triples.push(triple(\n                identifier_id,\n                'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n                'http://schema.org/PropertyValue'));\n\n              triples.push(triple(\n                identifier_id,\n                'http://schema.org/propertyID',\n                'orcid'));\n\n              triples.push(triple(\n                identifier_id,\n                'http://schema.org/value',\n                orcid\n              ));\n            }\n            */\n\n          }\n          break;\n\n\n          /*\n\t\t\t// funding\n\t\t  case 'funder':\n\t\t\tvar n = doc.message[i].length;\n\t\t\tfor (var j = 0; j < n; j++) {\n\t\t\t  var funder_id = '';\n\n\t\t\t  // create identifier for funder\n\t\t\t  if (doc.message[i][j].DOI) {\n\t\t\t\tfunder_id = 'http://identifiers.org/doi/' + doc.message[i][j].DOI;\n\t\t\t  } else {\n\t\t\t\t// #hash identifier \n\t\t\t\tfunder_id = subject_id + '#funder_' + (j + 1);\n\t\t\t  }\n\n\t\t\t  // create funder \n\t\t\t  triples.push(triple(funder_id,\n\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t'http://schema.org/Organisation'));\n\n\t\t\t  triples.push(triple(funder_id,\n\t\t\t\t'http://schema.org/name',\n\t\t\t\tdoc.message[i][j].name));\n\n\t\t\t  // role\n\t\t\t  var m = doc.message[i][j].award.length;\n\n\t\t\t  if (m == 0) {\n\t\t\t\t// funder but award not known\n\t\t\t\tvar award_id = funder_id + '/award';\n\n\t\t\t\ttriples.push(triple(award_id,\n\t\t\t\t  'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t  'http://schema.org/Role'));\n\n\t\t\t\t// link to funder \n\t\t\t\ttriples.push(triple(award_id,\n\t\t\t\t  'http://schema.org/funder',\n\t\t\t\t  funder_id));\n\n\t\t\t\t// link role to work         \n\t\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t  'http://schema.org/funder',\n\t\t\t\t  award_id));\n\t\t\t  } else {\n\t\t\t\t// we have one or more awards\n\t\t\t\tfor (var a = 0; a < m; a++) {\n\t\t\t\t  var award_id = funder_id + '/award_' + (a+1);\n\n\t\t\t\t  triples.push(triple(award_id,\n\t\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t\t'http://schema.org/Role'));\n\n\t\t\t\t  triples.push(triple(award_id,\n\t\t\t\t\t'http://schema.org/roleName',\n\t\t\t\t\tdoc.message[i][j].award[a]\n\t\t\t\t  ));\n\n\t\t\t\t  // link to funder \n\t\t\t\t  triples.push(triple(award_id,\n\t\t\t\t\t'http://schema.org/funder',\n\t\t\t\t\tfunder_id));\n\n\t\t\t\t  // link role to work         \n\t\t\t\t  triples.push(triple(subject_id,\n\t\t\t\t\t'http://schema.org/funder',\n\t\t\t\t\taward_id));\n\t\t\t\t}\n\t\t\t  }\n\t\t\t}\n\t\t\tbreak;\n\t\t\t*/\n\n          /*\n\n\t\t\t// links to representions such as PDFs, XML, HTML, etc.\n\t\t\t// may be links to text mining sources\n\t\t  case 'link':\n\t\t\tvar n = doc.message[i].length;\n\t\t\tfor (var j = 0; j < n; j++) {\n\t\t\t  var link_id = subject_id + '#link_' + (j + 1);\n\n\t\t\t  // type\n\t\t\t  triples.push(triple(link_id,\n\t\t\t\t'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n\t\t\t\t'http://schema.org/CreativeWork'));\n\n\t\t\t  if (doc.message[i][j].URL) {\n\t\t\t\ttriples.push(triple(link_id,\n\t\t\t\t  'http://schema.org/url',\n\t\t\t\t  doc.message[i][j].URL));\n\n\t\t\t\tif (doc.message[i][j]['content-type']) {\n\t\t\t\t  triples.push(triple(link_id,\n\t\t\t\t\t'http://schema.org/fileFormat',\n\t\t\t\t\tdoc.message[i][j]['content-type']));\n\t\t\t\t}\n\n\t\t\t\t// link to work\n\t\t\t\ttriples.push(triple(subject_id,\n\t\t\t\t  'http://schema.org/workExample',\n\t\t\t\t  link_id));\n\t\t\t  }\n\t\t\t}\n\t\t\tbreak;\n\t\t\t\n\t\t*/\n\n\n        default:\n          break;\n      }\n    }\n\n    if (type == '') {\n      type = 'http://schema.org/CreativeWork';\n    }\n\n\n    // defaults\n    triples.push(triple(subject_id,\n      'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n      type));\n\n    output(doc, triples);\n  }\n}\n\nfunction(doc) {\n  if (doc['message-format']) {\n    if (doc['message-format'] == 'application/vnd.crossref-api-message+json') {\n      if (doc.message.stack) {\n        // CrossRef error\n      }\n      else {\n        message(doc);\n      }\n    }\n  }\n}\n// END COUCHDB VIEW"}},"language":"javascript"}

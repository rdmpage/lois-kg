{"_id":"_design/kmers","_rev":"7-693bc20decb382aadcf1261bf69d4903","views":{"matK":{"map":"// http://stackoverflow.com/a/29585704\nfunction cartesianProduct(a) { // a = array of array\n  var i, j, l, m, a1, o = [];\n  if (!a || a.length == 0) return a;\n\n  a1 = a.splice(0, 1)[0]; // the first array of a\n  a = cartesianProduct(a);\n  for (i = 0, l = a1.length; i < l; i++) {\n    if (a && a.length)\n      for (j = 0, m = a.length; j < m; j++)\n        o.push([a1[i]].concat(a[j]));\n    else\n      o.push([a1[i]]);\n  }\n  return o;\n}\n\nfunction(doc) {\n  if (doc.sequence && doc.gene) {\n\n    if (doc.gene.indexOf('matK') != -1) {\n\n      var output = {};\n      output.id = doc._id;\n      output.label = doc.organism;\n\n      var sequence = doc.sequence;\n      sequence = sequence.replace(/^(a|c|g|t)/, '');\n      sequence = sequence.toUpperCase();\n\n      output.length = sequence.length;\n\n      var cp =\n        cartesianProduct(\n          [\n            ['A', 'C', 'G', 'T'],\n            ['A', 'C', 'G', 'T'],\n            ['A', 'C', 'G', 'T'],\n            ['A', 'C', 'G', 'T'],\n            ['A', 'C', 'G', 'T']\n          ]\n        );\n\n      // encode sequences as 5-tuples\n      output.tuples = {};\n      var len = sequence.length;\n\n\n      for (var i in cp) {\n        output.tuples[cp[i].join(\"\")] = 0;\n      }\n\n\n\n      for (var j = 0; j < len - 5; j++) {\n        var tuple = sequence.substring(j, j + 5);\n\n        if (tuple in output.tuples) {\n          output.tuples[tuple]++;\n        }\n      }\n\n      var taxon = doc.lineage[doc.lineage.length - 1];\n\n      emit(taxon, output);\n    }\n  }\n}"}},"language":"javascript"}
